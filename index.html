<!doctype html>
<html class="no-js" lang="">
    <head>
      <meta charset="utf-8">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      <title></title>
      <meta name="description" content="">
      <meta name="viewport" content="width=device-width, initial-scale=1">

      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
      <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-providers/1.1.15/leaflet-providers.min.js"></script>
      <script src="https://d3js.org/d3.v4.min.js"></script>

      <style>

        body {
          font: 12px sans-serif;
          margin: 0;
          padding: 0;
        }

        html, body{
          height: 98%;
        }

        #map, #content{
          height: 50%;
          margin: 10px;
        }



        #chart{
          /*margin: 0 auto;*/
          height: 100%;
          /*background-color: red;*/
        }

        #chart > svg{
          display: block;
          margin: 0 auto;
        }

      </style>

    </head>
    <body>

      <div id="map"></div>
      <div id="content">
        <div id="chart"></div>
      </div>
      
      <script type="text/javascript">

        // marker styles
        var circleWaiting = {
            color: "red",
            fillColor: "red",
            fillOpacity: 0.5,
            opacity: 0.5,
            radius: 7
        };

        var circleNormal = {
          color: "green",
          fillColor: "green",
          fillOpacity: 0.5,
          opacity: 0.5,
          radius: 5
        }

        // set up map
        var sthlm = [59.311162, 18.074806];
        var circle;
        var map = L.map('map');
        L.tileLayer.provider('OpenStreetMap.BlackAndWhite').addTo(map);
        map.setView(sthlm, 13);

        map.on('click', onMapClick);

        // get date ranges
        var months = 1; // lets start with one to keep the requests down for a while
        var dates = { "thisYear":{}, "lastYear":{} };
        dates.thisYear.start = new Date();
        dates.thisYear.start.setMonth(dates.thisYear.start.getMonth() - months); // today - 3 monhts
        dates.thisYear.end = new Date(); // today
        dates.lastYear.start = new Date();
        dates.lastYear.start.setYear(dates.lastYear.start.getFullYear() - 1); // today - 1 year
        dates.lastYear.end = new Date(dates.lastYear.start);
        dates.lastYear.end.setMonth(dates.lastYear.end.getMonth() + months); // (today - 1 yeary) + 3 months

        function onMapClick(e){
          if(circle == null){
            circle = L.circleMarker(sthlm, circleWaiting).addTo(map);
          }
          circle.setLatLng(e.latlng);
          circle.setStyle(circleWaiting);
        }

        function getNewData(lat, lng, start, end){

          var url =
            "/darkskySeason?lat=" + lat
            + "&lng=" + lng
            + "&startDate=" + start
            + "&endDate=" + end;

          d3.json(url, function(err, json){
            dispatch.call("statechange", this, json);
          });

        }

        var dispatch = d3.dispatch("init", "load", "statechange", "resize");

        dispatch.on("init.bar", function(){
          var margin = {
            top: 10,
            bottom: 10,
            left: 10,
            right: 10
          };

          var height = parseInt(d3.select("#chart").style("height")) - (margin.top + margin.bottom),
              width = height * 1.77777;


          var svg = d3.select("#chart").append("svg")
            .attr("width", width + (margin.left + margin.right))
            .attr("height", height + (margin.top + margin.bottom))
            .append("g")
              .attr("transform", "translate(" + margin.left + ", " + margin.right + ")");

          dispatch.on("statechange.bar", function(data){

          });
            
        });

        dispatch.call("init", this);

	    </script>
    
    </body>
</html>





